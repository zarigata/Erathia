[gd_scene load_steps=15 format=3 uid="uid://dsnap_system_test"]

[ext_resource type="Material" path="res://_assets/materials/smooth_surface.tres" id="1_material"]
[ext_resource type="Script" uid="uid://b5d3nwn5eweku" path="res://_engine/terrain/biome_aware_generator.gd" id="2_generator"]
[ext_resource type="PackedScene" uid="uid://bqx8k2m7v4yjr" path="res://_player/player.tscn" id="3_player"]
[ext_resource type="PackedScene" uid="uid://dh3xqk7m2yqvs" path="res://_ui/hud.tscn" id="4_hud"]
[ext_resource type="PackedScene" uid="uid://dkm7xvw2q8pnf" path="res://_ui/inventory_ui.tscn" id="5_inv_ui"]
[ext_resource type="Script" uid="uid://cs0cq33rgd2iv" path="res://_engine/terrain/main_terrain_init.gd" id="6_terrain_init"]

[sub_resource type="ProceduralSkyMaterial" id="ProceduralSkyMaterial_1"]
sky_top_color = Color(0.4, 0.6, 0.9, 1)
sky_horizon_color = Color(0.7, 0.8, 0.9, 1)
ground_bottom_color = Color(0.3, 0.25, 0.2, 1)
ground_horizon_color = Color(0.5, 0.5, 0.5, 1)

[sub_resource type="Sky" id="Sky_1"]
sky_material = SubResource("ProceduralSkyMaterial_1")

[sub_resource type="Environment" id="Environment_1"]
background_mode = 2
sky = SubResource("Sky_1")
ambient_light_source = 2
ambient_light_sky_contribution = 0.3
ambient_light_energy = 0.3

[sub_resource type="VoxelGeneratorScript" id="VoxelGeneratorScript_1"]
script = ExtResource("2_generator")

[sub_resource type="VoxelMesherTransvoxel" id="VoxelMesherTransvoxel_1"]
texturing_mode = 1

[sub_resource type="GDScript" id="GDScript_test_ui"]
script/source = "extends Control
## Test UI for SnapSystem - displays build mode status and debug info

@onready var mode_label: Label = $VBoxContainer/ModeLabel
@onready var piece_label: Label = $VBoxContainer/PieceLabel
@onready var snap_label: Label = $VBoxContainer/SnapLabel
@onready var valid_label: Label = $VBoxContainer/ValidLabel
@onready var position_label: Label = $VBoxContainer/PositionLabel
@onready var rotation_label: Label = $VBoxContainer/RotationLabel
@onready var help_label: Label = $VBoxContainer/HelpLabel

func _ready() -> void:
	# Connect to SnapSystem signals
	if SnapSystem:
		SnapSystem.build_mode_changed.connect(_on_build_mode_changed)
		SnapSystem.piece_selection_changed.connect(_on_piece_selection_changed)
		SnapSystem.preview_validity_changed.connect(_on_preview_validity_changed)
	
	_update_help_text()

func _process(_delta: float) -> void:
	if not SnapSystem:
		return
	
	# Update position and rotation
	if SnapSystem.is_in_build_mode():
		var pos := SnapSystem.get_preview_position()
		position_label.text = \"Position: (%.1f, %.1f, %.1f)\" % [pos.x, pos.y, pos.z]
		rotation_label.text = \"Rotation: %.0fÂ°\" % rad_to_deg(SnapSystem.get_preview_rotation())
	else:
		position_label.text = \"Position: N/A\"
		rotation_label.text = \"Rotation: N/A\"

func _on_build_mode_changed(mode: int) -> void:
	match mode:
		SnapSystem.BuildMode.IDLE:
			mode_label.text = \"Mode: IDLE\"
			mode_label.modulate = Color.WHITE
		SnapSystem.BuildMode.PREVIEW:
			mode_label.text = \"Mode: PREVIEW\"
			mode_label.modulate = Color.CYAN
		SnapSystem.BuildMode.PLACING:
			mode_label.text = \"Mode: PLACING\"
			mode_label.modulate = Color.YELLOW

func _on_piece_selection_changed(piece_id: String) -> void:
	piece_label.text = \"Piece: %s\" % piece_id

func _on_preview_validity_changed(is_valid: bool) -> void:
	if is_valid:
		valid_label.text = \"Valid: YES\"
		valid_label.modulate = Color.GREEN
	else:
		valid_label.text = \"Valid: NO\"
		valid_label.modulate = Color.RED

func _update_help_text() -> void:
	help_label.text = \"\"\"Controls:
B - Toggle Build Mode
LMB - Place Piece
RMB/Esc - Cancel
R - Rotate CW
Shift+R - Rotate CCW\"\"\"
"

[sub_resource type="GDScript" id="GDScript_resource_giver"]
script/source = "extends Node
## Gives player starting resources for testing building

func _ready() -> void:
	# Wait a frame for Inventory to initialize
	await get_tree().process_frame
	
	if Inventory:
		# Give player resources to build with
		Inventory.add_resource(\"wood\", 100)
		Inventory.add_resource(\"stone\", 100)
		Inventory.add_resource(\"iron_ore\", 50)
		print(\"[TestSnapSystem] Added starting resources for building\")
"

[node name="TestSnapSystem" type="Node3D"]
script = ExtResource("6_terrain_init")

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_1")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(0.866025, -0.353553, 0.353553, 0, 0.707107, 0.707107, -0.5, -0.612372, 0.612372, 0, 50, 0)
shadow_enabled = true

[node name="VoxelLodTerrain" type="VoxelLodTerrain" parent="."]
lod_count = 5
lod_distance = 32.0
material = ExtResource("1_material")
collision_lod_count = 2
run_stream_in_editor = false
generator = SubResource("VoxelGeneratorScript_1")
mesher = SubResource("VoxelMesherTransvoxel_1")

[node name="Player" parent="." instance=ExtResource("3_player")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 50, 0)

[node name="HUD" parent="." instance=ExtResource("4_hud")]
player_path = NodePath("../Player")

[node name="InventoryUI" parent="." instance=ExtResource("5_inv_ui")]

[node name="ResourceGiver" type="Node" parent="."]
script = SubResource("GDScript_resource_giver")

[node name="BuildTestUI" type="Control" parent="."]
layout_mode = 3
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -250.0
offset_bottom = 300.0
grow_horizontal = 0
script = SubResource("GDScript_test_ui")

[node name="Panel" type="Panel" parent="BuildTestUI"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="VBoxContainer" type="VBoxContainer" parent="BuildTestUI"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 10.0
offset_top = 10.0
offset_right = -10.0
offset_bottom = -10.0
grow_horizontal = 2
grow_vertical = 2

[node name="TitleLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "=== Build System Test ==="
horizontal_alignment = 1

[node name="ModeLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Mode: IDLE"

[node name="PieceLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Piece: None"

[node name="SnapLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Snap: NONE"

[node name="ValidLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Valid: N/A"

[node name="PositionLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Position: N/A"

[node name="RotationLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Rotation: N/A"

[node name="HSeparator" type="HSeparator" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2

[node name="HelpLabel" type="Label" parent="BuildTestUI/VBoxContainer"]
layout_mode = 2
text = "Controls:
B - Toggle Build Mode
LMB - Place Piece
RMB/Esc - Cancel
R - Rotate CW
Shift+R - Rotate CCW"
